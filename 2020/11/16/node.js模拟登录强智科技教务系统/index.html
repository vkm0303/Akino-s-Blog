<!DOCTYPE html>
<html>

<head>
  <title>Akino's Blog</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="
      width=device-width, 
      initial-scale=1.0, 
      minimum-scale=1.0, 
      maximum-scale=1.0,
      user-scalable=no
    " />
  <link rel="icon" href="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/logo.png">

  
<link rel="stylesheet" href="/css/main.css">


  
<script src="/js/lib/jquery-3.6.3.min.js" defer></script>

  
  
<script src="/js/lib/highlight.min.js" defer></script>

  
<script src="/js/main.js" type="module" defer></script>

  
<script src="/js/page/header.js" type="module" defer></script>

  
<script src="/js/page/side-menu.js" type="module" defer></script>

  
<script src="/js/page/search/index.js" defer></script>


  
  
<script src="/js/lib/valine.min.js"></script>

  

  

  
  
<script src="/js/page/search/local-search.js" type="module" defer></script>

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body style="position: relative;">
  
<div id="loading-box">
  <div class="wave">
    <div class="wave-child wave1"></div>
    <div class="wave-child wave2"></div>
    <div class="wave-child wave3"></div>
    <div class="wave-child wave4"></div>
    <div class="wave-child wave5"></div>
  </div>
</div>

<script>
  window.addEventListener("load", function() {
    document.body.style.overflow = "auto";
    document.getElementById("loading-box").classList.add("loaded")
  }, false)
</script>

  <div class="bg-wrapper">
  <canvas id="bg-canvas" />
</div>
  <div class="side-menu-container animate__animated animate__faster">
  <ul class="menu animate__animated animate__faster">
    <li class="menu-item"}><a href="/" title="首页">首页</a></li><li class="menu-item"}><a href="/projects" title="项目">项目</a></li><li class="menu-item"}><a href="/about" title="关于">关于</a></li><li class="menu-item"}><a href="/message" title="留言板">留言板</a></li><li class="menu-item"}><a href="/links" title="友链">友链</a></li>
    <li class="category-menu-wrapper">
      <div class="menu-item-name">
        <span>分类</span>
        <span class="iconfont icon-chevron-bottom"></span>
      </div>
      <ul class="category-menu-list"><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E5%85%B6%E5%AE%83/">其它</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E6%B1%82%E8%81%8C/">求职</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86/">版本管理</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </li>
    <li class="iconfont icon-close-circle"></li>
  </ul>
</div>
  
<div class="search-pop-overlay">
  <div class="popup search-popup">
    
    <div class="search-header">
  <h2 class="search-title">
    本地搜索
    <i class="popup-btn-close iconfont icon-close"></i>
  </h2>
  <div class="search-input-container">
    <input class="search-input" autocomplete="off" autocapitalize="off" maxlength="80" placeholder="请输入关键字" spellcheck="false" type="search">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result flex flex-column">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>    
  </div>
</div>

  <header class="main-header animate__animated animate__fadeInDown">
  <a class="blogger-info flex flex-align-center" href="/">
    <img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/logo.png" alt="avatar">
    <span>Akino's Blog </span>
  </a>
  <nav>
    <ul class="menu flex flex-align-center">
      <li class="menu-item"}><a href="/" title="首页">首页</a></li><li class="menu-item"}><a href="/projects" title="项目">项目</a></li><li class="menu-item"}><a href="/about" title="关于">关于</a></li><li class="menu-item"}><a href="/message" title="留言板">留言板</a></li><li class="menu-item"}><a href="/links" title="友链">友链</a></li>
      <li class="menu-category">
        <div class="flex flex-align-center">
          <span>分类</span>
          <span class="iconfont icon-chevron-bottom"></span>
        </div>
        <ul class="category-menu-list"><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E5%85%B6%E5%AE%83/">其它</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E6%B1%82%E8%81%8C/">求职</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86/">版本管理</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></li><li class="category-menu-list-item"><a class="category-menu-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
      </li>
    </ul>
  </nav>
  <div class="right-icon flex flex-align-center">
    <span class="search-popup-trigger iconfont icon-search"></span>
    <span class="iconfont icon-view-list"></span>
  </div>
</header>
<div class="header-slot"></div>
  <main class="page-container">
    <div class="page-post-container animate__animated animate__fadeIn">
  <section class="post-wrapper">
    <header class="post-header">
      
      <img class="post-cover" src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/nodejs.png" alt="Node.js模拟登录强智科技教务系统">
      
      
      <span class="post-title">Node.js模拟登录强智科技教务系统</span>
      
      <div class="post-publish-info-wrapper flex">
        <img class="author-avatar" src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/logo.png" alt="">
        <div class="post-info flex flex-column flex-space-around">
          <div>
            Akino
            <span>· 11/16, 2020 · </span>
            <span id="/2020/11/16/node.js%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E5%BC%BA%E6%99%BA%E7%A7%91%E6%8A%80%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F/" class="leancloud_visitors" data-flag-title="Node.js模拟登录强智科技教务系统">
              阅读
              
              <span class="leancloud-visitors-count"></span>
              
            </span>
          </div>
          <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li></ul>
        </div>
        </span>
      </div>
    </header>
    <article class="post-content markdown">
      <!-- <a name="index" style=" position: relative;top: -120px;display: block;height: 0;overflow: hidden;"></a> -->
      <h2 id="一、抓包、分析登录请求">一、抓包、分析登录请求</h2>
<p>首先从首页正常登录教务系统，成功登入教务系统后，F12 打开检查，然后点击“Network&quot;/&quot;网络&quot;，可以看到一下界面</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-1.png" alt="avatar"></p>
<p>在这里可以看到一共有四个请求，不出意外的话，应该是按前后顺序发起请求的，不放心的话可以点击第一个请求，然后点击“Initiator”查看请求链</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-2.png" alt="avatar"></p>
<p>确定请求顺序之后，开始分析第一个请求的 headers</p>
<p>在这里可以得到请求的 url、请求方法和响应类型</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-3.png" alt="avatar"></p>
<p>然后再观察 Response Headers 和 Form Data</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-6.png" alt="avatar"></p>
<p>通过这两个框起来的数据和 302 状态码可以知道请求和响应的过程</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-4.png" alt="avatar"></p>
<p>我们需要向“https://isea.sztu.edu.cn/Logon.do?method=logon”发送一个验证码encoded，然后返回一个重定向的链接Location.</p>
<p>那么问题来了，怎么得到验证码？因为 form data 中没有账号密码的信息，因此可以推断该验证码是把账号和密码加密后的结果，这时候我们就要从源代码中找加密函数了</p>
<p>刚开始找到下面这个比较可疑的文件，但是大致看了一下没有出现 account/password 等名称就放弃了（其实是太复杂了 qaq）</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-5.png" alt="avatar"></p>
<p>后来想想不太对劲，我是在登陆后的源文件找加密函数，但是这个验证码应该是在登录前就应该处理完成的</p>
<p>于是又返回首页的源文件查找，只有应该 index 的文件可能有加密方法</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-7.png" alt="avatar"></p>
<p>然后还真发现了，在 onSubmit()事件里面，并且发现了一个可疑 url，我猜 request hearders 里面的 cookie 值会从这个 url 获取，这个后面写代码时在细说。</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-8.png" alt="avatar"></p>
<p>既然我们拿到来加密方法，那么我们直接拿来用就行，不过有些地方需要改一下，如请求和获取账号密码那一段。</p>
<p>首先访问一下 https://isea.sztu.edu.cn/Logon.do?method=logon&amp;flag=sess，看一下请求头和返回值之类的。</p>
<p>确实返回了一个 cookie（注意：这个在浏览器的调试工具看不到，要借助其它工具）</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-9.png" alt="avatar"></p>
<p>我们要先保存一下这个 cookie，用于登录请求</p>
<p><strong>改写代码如下：</strong></p>
<pre><code class="language-javascript">var Cookie = '';
var encoded = '';
//封装请求头
var postOption1 = &#123;
  url: 'https://isea.sztu.edu.cn/Logon.do?method=logon&amp;flag=sess',
  method: 'POST',
  json: true,
  headers: &#123;
    'content-type': 'application/json'
  &#125;,
  body: JSON.stringify(&#123;&#125;)
&#125;;
try &#123;
  await request(postOption1, (err, response, body) =&gt; &#123;
    Cookie = response.headers['set-cookie'][0].substr(0, 44); //保存cookie
  &#125;).then(dataStr =&gt; &#123;
    //将请求返回的字符串和账号密码进行加密
    if (dataStr == 'no') &#123;
      return false;
    &#125; else &#123;
      var scode = dataStr.split('#')[0];
      var sxh = dataStr.split('#')[1];
      var code = account + '%%%' + password;
      for (var i = 0; i &lt; code.length; i++) &#123;
        if (i &lt; 20) &#123;
          encoded =
            encoded +
            code.substring(i, i + 1) +
            scode.substring(0, parseInt(sxh.substring(i, i + 1)));
          scode = scode.substring(
            parseInt(sxh.substring(i, i + 1)),
            scode.length
          );
        &#125; else &#123;
          encoded = encoded + code.substring(i, code.length);
          i = code.length;
        &#125;
      &#125;
    &#125;
  &#125;);
&#125; catch &#123;&#125;
</code></pre>
<p>成功拿到 encoded</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-10.png" alt="avatar"></p>
<p>那么继续分析请求</p>
<p>点击第二个请求，和第一个请求差不多，不过是 get 方法，没什么特别注意的，继续下一个</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-11.png" alt="avatar"></p>
<p>这里可以发现又返回了一个 cookie，而下一步请求就就是登陆后的页面了，所以可以断定这个 cookie 是登录成功的标志</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-12.png" alt="avatar"></p>
<p>最后就是能否登录成功的关键了，最后一个请求的 headers 中的 cookie 有两个参数，应该就是开始保存的 cookie 和上一步返回的 cookie 拼接起来了。</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-13.png" alt="avatar"></p>
<p>基本的分析已经完成了，那么可以开始动手写代码了</p>
<h2 id="二、模拟登录">二、模拟登录</h2>
<p>加密这一部在上面已经说过了，这里就不重复了</p>
<p>直接开始登录请求</p>
<pre><code class="language-javascript">//封装请求头
var getOption = &#123;
  url: '',
  method: 'GET',
  json: true,
  headers: &#123;
    'Content-Type': 'application/x-www-form-urlencoded',
    Cookie: Cookie
  &#125;
&#125;;
var postOption2 = &#123;
  url: 'https://isea.sztu.edu.cn/Logon.do?method=logon',
  method: 'POST',
  json: true,
  headers: &#123;
    'Content-Type': 'application/x-www-form-urlencoded',
    Cookie: Cookie,
    Host: 'isea.sztu.edu.cn'
  &#125;,
  form: &#123;
    view: '1',
    useDogCode: '',
    encoded: encoded
  &#125;
&#125;;
try &#123;
  //请求https://isea.sztu.edu.cn/Logon.do?method=logon
  await request(postOption2, async (err, response, body) =&gt; &#123;
    //用于302会自动重定向，因此需要在这里截取数据
    if (response.statusCode === 302) &#123;
      getOption.url = response.headers.location;
      try &#123;
        //请求返回的location中url地址
        await request(getOption, async (err, response, body) =&gt; &#123;
          Cookie += response.headers['set-cookie'][0].substr(0, 44); //拼接cookie
          getOption.headers.Cookie = Cookie;
          try &#123;
            //请求返回的location中url地址，由于地址一样，不再重新赋值
            //最后一个请求如果成功登录，那么body的值就是登录成功的首页html
            await request(getOption, (err, response, body) =&gt; &#123;
              let nameIdx = body.indexOf('姓');
              let noIdx = body.indexOf('号');
              userInfo.name = body.substring(nameIdx + 3, nameIdx + 7);
              userInfo.no = body.substring(noIdx + 2, noIdx + 14);
              userInfo.name = userInfo.name.replace(/[^\u4e00-\u9fa5|,]+/, '');
            &#125;);
          &#125; catch &#123;&#125;
        &#125;);
      &#125; catch &#123;&#125;
    &#125;
  &#125;);
  return userInfo;
&#125; catch &#123;
  return userInfo;
&#125;
</code></pre>
<p>代码用的嵌套比较多，有回调地狱的感觉，有机会再调整。</p>
<p>登录成功的结果</p>
<p><img src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/pasted-14.png" alt="avatar"></p>

    </article>
    <!--  -->
    <div class="post-prev-next">
  
  <div class="link-wrapper">
    
    <a style="background-image: url(https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/yapi.png);" class="link-cover" href="/2021/02/21/centOS%20%E9%83%A8%E7%BD%B2YApi%20api%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0/">
      <div class="overlay"></div>
    </a>
    
    <div class="link-text">
      <span>上一篇</span>
      <span class="link-title">centOS 部署YApi api管理平台</span>
    </div>
  </div>
  
  
  <div class="link-wrapper">
    
    <a style="background-image: url(https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/vue.png);" class="link-cover" href="/2020/08/17/Vue%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">
      <div class="overlay"></div>
    </a>
    
    <div class="link-text">
      <span>下一篇</span>
      <span class="link-title">Vue学习记录</span>
    </div>
  </div>
  
</div>
    
    

<div class="divide"></div>


<div class="iconfont icon-comment"><span>评论</span></div>

<div id="comment" class="comment markdown"></div>
<script>
  new Valine({
    el: '#comment',
    appId: '3QKRVHpL9EPJpCUkekn4XDbR-gzGzoHsz',
    appKey: 'BrY6HeaAcdwDscZNxC3TM7LO',
    avatar: 'retro',
    placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
    pageSize: 15,
    visitor: true,
    recordIP: true,
    lang: "zh-CN"
  });
</script>

    
  </section>
  <section class="aside-wrapper">
  <aside class="aside-content">
    <div class="aside-card post-toc">
      <header class="aside-card-title">
        <span class="iconfont icon-toc"></span>目录
      </header>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%8A%93%E5%8C%85%E3%80%81%E5%88%86%E6%9E%90%E7%99%BB%E5%BD%95%E8%AF%B7%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">一、抓包、分析登录请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">二、模拟登录</span></a></li></ol>
    </div>
    <div class="aside-card latest-posts">
      <header class="aside-card-title">
        <span class="iconfont icon-history"></span>最新推荐
      </header>
      <ul class="latest-post-list">
    <li class="latest-post">
      <a class="post-link" href="/2023/03/10/Electron%E8%B8%A9%E5%9D%91%E4%B8%93%E9%A2%98/">
        <img class="post-cover" src="/images/no-cover.png" />
        <div class="post-info">
          <span class="title">Electron 踩坑专题</span>
          <span class="time">2023-03-10</span>
        </div>
      </a>
    </li>
  
    <li class="latest-post">
      <a class="post-link" href="/2023/03/02/Hexo%E4%B8%BB%E9%A2%98%EF%BC%9Ahexo-theme-alog/">
        <img class="post-cover" src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/hexo-theme-alog.png" />
        <div class="post-info">
          <span class="title">Hexo主题：Alog</span>
          <span class="time">2023-03-02</span>
        </div>
      </a>
    </li>
  
    <li class="latest-post">
      <a class="post-link" href="/2022/09/02/uniapp%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0video%E7%BB%84%E4%BB%B6ref%E9%97%AE%E9%A2%98/">
        <img class="post-cover" src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/uniapp.png" />
        <div class="post-info">
          <span class="title">uniapp获取不到video组件ref问题</span>
          <span class="time">2022-09-02</span>
        </div>
      </a>
    </li>
  
    <li class="latest-post">
      <a class="post-link" href="/2022/01/25/react%E9%85%8D%E7%BD%AEsetupProxy%E4%B9%8B%E5%90%8E%E9%A1%B5%E9%9D%A2%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80/">
        <img class="post-cover" src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/react.png" />
        <div class="post-info">
          <span class="title">react配置setupProxy之后页面无法打开</span>
          <span class="time">2022-01-25</span>
        </div>
      </a>
    </li>
  
    <li class="latest-post">
      <a class="post-link" href="/2021/11/23/%E5%AD%97%E8%8A%82%E4%BA%8C%E9%9D%A2%E5%A4%8D%E7%9B%98/">
        <img class="post-cover" src="https://blog-1302037900.cos.ap-guangzhou.myqcloud.com/images/covers/bytedance.png" />
        <div class="post-info">
          <span class="title">【实习】11.23 字节二面复盘(1h20min)</span>
          <span class="time">2021-11-23</span>
        </div>
      </a>
    </li>
  </ul>
    </div>
  </aside>
</section>
</div>

<div class="preview-overlay">
  <div class="preview-wrapper">
    <img class="preview-img" alt="Preview" />
    <div class="slot"></div>
    <ul class="img-list"></ul>
  </div>
</div>

<script src="/js/page/post/index.js" type="module" defer></script>

  </main>
  <footer class="page-footer animate__animated animate__fadeIn">
  
  <span class="copyright">Copyright © 2020-2023 Akino</span>
  
  <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/vkm0303/hexo-theme-alog">Hexo-theme-alog</a></span>
</footer>
</body>


    <script>
      window.CONFIG = {"search":{"path":"/search.xml","local_search":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":true,"trigger":"auto"}},"i18n":{"search":{"title":"本地搜索","result_title":"${resultNum} 条结果","placeholder":"请输入关键字","no_result":"搜索不到呢~","tips":"搜索"}},"valine":{"enable":true,"appId":"3QKRVHpL9EPJpCUkekn4XDbR-gzGzoHsz","appKey":"BrY6HeaAcdwDscZNxC3TM7LO","avatar":"retro","placeholder":"ヾﾉ≧∀≦)o来啊，快活啊!","pageSize":15,"visitor":true,"recordIP":true}};
    </script>
  

</html>